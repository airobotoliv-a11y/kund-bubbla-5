<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI‑chatt</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
    #chat { width: 100%; max-width: 560px; background: #fff; margin: 24px; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.08); display: flex; flex-direction: column; height: 80vh; overflow: hidden; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; font-weight: 600; }
    #messages { flex: 1; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #fafbfc; }
    .msg { max-width: 78%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; word-wrap: break-word; animation: fade .15s ease; }
    .user { align-self: flex-end; background: #d1e7dd; }
    .assistant { align-self: flex-start; background: #e9ecef; }
    .system { align-self: center; background: #fff3cd; color: #6c5a00; font-size: 12px; }
    .loading { font-style: italic; color: #666; }
    form { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #eee; }
    input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #dadce0; font-size: 16px; outline: none; }
    button { padding: 0 16px; border: none; border-radius: 8px; background: #0d6efd; color: #fff; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    @keyframes fade { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="chat">
    <header>AI‑chatt</header>
    <div id="messages"></div>
    <form id="chatForm">
      <input id="userInput" type="text" placeholder="Skriv ett meddelande..." autocomplete="off" required />
      <button type="submit">Skicka</button>
    </form>
  </div>

  <script>
    const webhookUrl = "https://hook.eu2.make.com/qhakqbhaq75m0tj6cfv2hqhlr71rrv1p"; // <-- din Make-webhook URL

    const messagesEl = document.getElementById("messages");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("userInput");

    // Initiera session-minne med en system-prompt om det saknas
    let history = JSON.parse(sessionStorage.getItem("chatHistory") || "[]");
    if (!history.length || history[0]?.role !== "system") {
      history = [{
        role: "system",
        content: "Du är en hjälpsam svensk assistent i en chattbubbla. Svara kort, konkret och fortsätt tråden baserat på kontexten i messages. Be inte om onödig förtydligande info. Ingen hälsningsfras om användaren inte hälsar först."
      }];
      sessionStorage.setItem("chatHistory", JSON.stringify(history));
    }
    render();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      // Lägg till user-meddelande
      history.push({ role: "user", content: text });
      sessionStorage.setItem("chatHistory", JSON.stringify(history));
      input.value = "";
      render();

      // Lägg till loading-rad i UI (ej i payload)
      const loadingId = "loading-" + Date.now();
      addLoading(loadingId);

      try {
        const payload = { messages: history }; // skicka ALLT, inkl system
        const res = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const textResp = await res.text();
        removeLoading(loadingId);

        // För att felsöka: avkommentera nästa rad för att se rått svar
        // console.log("Rått svar:", textResp);

        if (!res.ok) throw new Error("HTTP " + res.status + ": " + textResp);

        let data;
        try {
          data = JSON.parse(textResp);
        } catch (e2) {
          throw new Error("Ogiltig JSON från servern.");
        }

        if (data && typeof data.reply === "string") {
          history.push({ role: "assistant", content: data.reply });
          sessionStorage.setItem("chatHistory", JSON.stringify(history));
          render();
        } else {
          throw new Error("Svaret saknar 'reply'.");
        }
      } catch (err) {
        removeLoading(loadingId);
        history.push({ role: "assistant", content: "⚠️ Kunde inte hämta svar. " + (err.message || "") });
        render();
      }
    });

    function render() {
      messagesEl.innerHTML = "";
      for (const m of history) {
        if (m.role === "system") continue; // visa inte systemprompten
        const div = document.createElement("div");
        div.className = `msg ${m.role}`;
        div.textContent = m.content;
        messagesEl.appendChild(div);
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addLoading(id) {
      const div = document.createElement("div");
      div.className = "msg assistant loading";
      div.dataset.id = id;
      div.textContent = "Skriver…";
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function removeLoading(id) {
      const el = messagesEl.querySelector(`.loading[data-id="${id}"]`);
      if (el) el.remove();
    }
  </script>
</body>
</html>
